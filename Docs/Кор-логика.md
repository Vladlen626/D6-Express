## 1) Базовая игра (кости как в KCD — упрощённая)

### Сущности

- **Матч**: 2 участника (P1 и AI/второй игрок), по очереди делают ходы.
- **Ход (turn)**: игрок набирает **очки хода (turn_points)**, пока не сделает **Pass** или не словит **BUST**.
- **Итоговые очки (total)**: очки, накопленные через Pass. Победа при достижении `TARGET_SCORE` (например 4000).

### Кости

- На столе всегда **6 костей**.
- В ходе есть два состояния костей:
    - **на столе (unbanked)** — только они бросаются,
    - **сохранённые (banked)** — отложены, в этом ходе больше не бросаются.
### Порядок хода

1. В начале хода все кости сброшены в “на столе”, `turn_points = 0`.
2. Игрок бросает **все несохранённые** кости.
3. Если бросок **не даёт ни одной скоринговой возможности** → **BUST**:
    - `turn_points` обнуляется,
    - ход заканчивается, передаётся другому.
    - (Есть предмет “щит” — может отменить один BUST, см. ниже.)
4. Если в броске есть скоринг-возможность — игрок может:
    - выбрать часть костей (кликом),
    - нажать **Save & Continue** или **Save & Pass**.
5. **Save**:
    - проверяется, что выбранные кости образуют **валидную скоринговую комбинацию**,
    - начисляются **base очки** за выбранное,
    - выбранные кости становятся **banked**.
6. После Save:
    - если **все 6 костей стали banked**, срабатывает **Hot dice**:
        - все кости снова становятся unbanked,
        - ход продолжается и игрок бросает снова (очки хода не теряются).
7. **Continue**:
    - игрок бросает оставшиеся unbanked кости и продолжает набирать turn_points.
8. **Pass**:
    - начисляется `turn_points (+/- эффекты модов/предметов)` в **total** игрока,
    - ход переходит другому игроку.

### Скоринг (упрощённый KCD/Farkle-стиль)

Выбранные кости должны состоять только из скоринговых элементов:

**Стриты (если выбрано ровно то, что надо):**
- 1–6 (6 костей): 1500
- 1–5 (5 костей): 500
- 2–6 (5 костей): 750

**Тройки и больше одинаковых:**

- 3×1 = 1000
- 3×(2..6) = face*100
- 4 одинаковых = ×2 от тройки
- 5 одинаковых = ×4
- 6 одинаковых = ×8  
    (то есть умножение на `2^(count-3)`)

**Одиночные:**
- 1 = 100
- 5 = 50

**Важно:** нельзя “выбирать” несскоринговые кости (2/3/4/6 одиночками), иначе выбор считается невалидным.

---

## 2) Модификаторы (Modifiers)

### Что это

Модификатор — это правило, которое **автоматически корректирует очки** по событиям.

### Где бывают
- **GLOBAL** — действует всегда на любого игрока.
- **Player-specific** — действует только на конкретного игрока.

### Когда срабатывают

В нашей системе есть события:
1. **On Roll** — сразу после завершения броска и до действий игрока  
    Используется для модов типа:
- “если в броске 3+ шестёрок, штраф -300”
- “за каждую выпавшую 5 +25”
2. **On Pass** — когда игрок нажимает Pass и фиксирует ход в total  
    Используется для:
- “налог -10% при Pass”
- “бонус при Pass”

### Порядок применения

При событии **On Roll**:
1. применяются **GLOBAL моды**
2. затем **моды текущего игрока**
3. каждое срабатывание может добавлять/убавлять очки `turn_points`
4. показывается уведомление: кто/что сработало и на сколько

При событии **On Pass**:
1. считаем `pass_delta` (отдельно от turn_points)
2. применяем GLOBAL, затем игрока
3. итог добавления в total:
    - `add_amount = max(0, turn_points + pass_delta)`
4. уведомления аналогично

### Формат модификатора (идея для генерации нейросетью)

Модификатор описывается:

- `name`
- `desc`
- `trigger`: on_roll или on_pass
- `condition`: что должно случиться (по rolled_values/rolled_info или по turn_points)
- `effect`: delta очков (+/-), мгновенно
- `note`: короткий текст в уведомление (“3+ шестёрок”, “стрит”, “-10%”)

---

## 3) Предметы (Items)

Предмет — это “модификатор”, но:
- бывает **пассивным** или **активным**
- активный имеет **кулдаун в ходах**
- активный может включать **временный флаг/состояние**, которое потом “съедается”

### Где бывают
- **GLOBAL Items** — на стол/партию
- **Player Items** — предметы игрока

### Пассивные предметы

Работают как модификаторы, но слушают больше событий:
- **On Roll**: после броска (как у модов)
- **On Save**: сразу после удачного сохранения комбинации
- **On Pass**: при Pass

Порядок применения (в текущей реализации):
- On Roll: сначала моды, потом предметы (global → player)
- On Save: предметы (global → player)
- On Pass: моды, потом предметы (global → player)

### Активные предметы

Игрок может нажать **USE** (в UI рядом с предметом) — но только если:
- предмет включён,
- **READY** (кулдаун = 0),
- условия по моменту соблюдены (обычно “сейчас мой ход, бросок уже закончился, нет BUST-перехода”).

После успешного использования:
- применяем эффект сразу,
- ставим кулдаун: `cooldown_turns` (в ходах).

#### Кулдаун в ходах

- хранится отдельно для каждого владельца:
    - global_cooldowns[item_id]
    - player_cooldowns[player_idx][item_id]
- уменьшается на 1 **в начале каждого хода** (каждого игрока).

### Временные состояния от активных предметов

Активка может не давать очки напрямую, а включать “флаг”, который потом будет использован при событии:

Примеры, которые уже есть:

- **Bust Shield**: если следующий бросок был бы BUST — вместо BUST отменяем и заставляем бросить снова; флаг сбрасывается.
    
- **Double Next Save**: следующее сохранение удваивает **base очки**; флаг сбрасывается.
    

### Формат предмета (идея для генерации нейросетью)

Предмет описывается:

- `name`
- `desc`
- `type`: passive/active
- `cooldown_turns` (для active)
- `triggers`: on_roll/on_save/on_pass (для passive)
- `activate_condition` (для active) — когда можно нажать USE
- `effect`:
    - либо `delta points` (turn_points или pass_delta)
    - либо `set_flag` (временный статус)
    - либо `mutate_state` (изменить кость, перебросить, зафиксировать и т.п.)
- `notification`: что показываем в логе

---

## 4) Разные кубики (Loaded Dice)

### Что это

Каждый кубик имеет **профиль** вероятностей выпадения граней:

- профиль = веса для граней 1..6 (`weights=(w1..w6)`)
    
- при “выборе значения” используется weighted random.
    

Пример:

- Fair: (1,1,1,1,1,1)
    
- Loaded Ones: (5,1,1,1,1,1) → единица чаще
    
- Evil: (1,3,3,3,1,3) → 2/3/4/6 чаще (хуже для скоринга)
    

### Персональные наборы

Перед матчем выбираются:
- **6 профилей кубиков для P1**
- **6 профилей кубиков для AI**  
    (каждая позиция — отдельный кубик со своим профилем)

Во время матча:
- когда начинается ход игрока — игра **подставляет его набор профилей** к текущим 6 костям.
- То есть одна и та же “позиция” кости может быть “счастливой” у одного и “злой” у другого.

### Формат кубика (идея для генерации нейросетью)

Кубик описывается:
- `code` (коротко)
- `name`
- `weights` (6 чисел)
- `theme/rarity` (если нужно)
- “для чего”: усиливает стратегии (например 1/5 для одиночек, 6 для модов, и т.п.)

---

## 5) Событийная модель (кратко, для дизайна контента)

Если кратко, у нас есть такие “хуки”, к которым можно привязывать контент:

**Roll завершён (до действий игрока):**

- mods.on_roll
- passive_items.on_roll  
    → изменяют `turn_points` сразу + уведомления

**Save выбранных костей:**
- начисляем base score
- active flags могут модифицировать base (например ×2)
- passive_items.on_save  
    → изменяют `turn_points`

**Pass:**
- mods.on_pass → `pass_delta`
- passive_items.on_pass → `pass_delta`
- `total += max(0, turn_points + pass_delta)`

**BUST:**
- если есть active-щит → отмена bust и повторный бросок
- иначе turn_points=0 и смена игрока

---

## 6) Что важно соблюдать при придумывании нового контента

### Баланс/читабельность

- Эффекты должны быть **понятны сразу**: “когда” и “сколько”.
- Старайся чтобы предмет/мод:
    - либо помогает набрать очки,
    - либо меняет риск (BUST/переброс/страховка),
    - либо добавляет “игровой стиль” (например бонус за 1/5, штраф за 6, и т.д.)

### Технические ограничения текущей версии
- Modifiers: только `on_roll` и `on_pass`.
- Items: passive `on_roll/on_save/on_pass`, active `activate()`.
- Loaded dice: только через веса вероятности, без “подмены после броска” (но это можно добавить).